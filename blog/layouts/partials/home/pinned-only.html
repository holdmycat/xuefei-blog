{{ $projects := where .Site.RegularPages "Section" "projects" }}
{{ $projects = $projects.ByDate.Reverse }}
{{ $pinned := first 1 (where $projects "Params.pinned" true) }}
{{ if eq (len $pinned) 0 }}
  {{ $pinned = first 1 $projects }}
{{ end }}
{{ if gt (len $pinned) 0 }}
  {{ $project := index $pinned 0 }}
  {{ $video := $project.Params.video_url }}
  {{ if $video }}
    {{ $video = replace $video "watch?v=" "embed/" }}
  {{ end }}
  {{ $cover := $project.Params.cover_image }}
  {{ $poster := $project.Params.poster | default $cover }}
  {{ $gallery := $project.Params.gallery_images }}
  {{ $summary := $project.Params.summary | default $project.Params.description }}
  {{ $release := $project.Params.release_date | default $project.Params.period }}

  <section class="pinned">
    <div class="pinned-shell">
      <div class="pinned-header">
        <h1 class="pinned-title">{{ $project.Title }}</h1>
      </div>

      <div class="pinned-grid" data-pinned-gallery>
        <div class="pinned-media">
          <div class="pinned-main" data-pinned-main>
            {{ if $video }}
              <iframe src="{{ $video }}" title="{{ $project.Title }} video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            {{ else }}
              {{ with $cover }}
                <img src="{{ . | relURL }}" alt="{{ $project.Title }} cover" loading="lazy" decoding="async">
              {{ end }}
            {{ end }}
          </div>
          <div class="pinned-thumbs">
            {{ if $video }}
              <button type="button" class="pinned-thumb active" data-media-type="video" data-src="{{ $video }}">
                <span class="thumb-label">Video</span>
              </button>
            {{ end }}
            {{ range first 6 $gallery }}
              <button type="button" class="pinned-thumb" data-media-type="image" data-src="{{ . | relURL }}">
                <img src="{{ . | relURL }}" alt="{{ $project.Title }} thumbnail" loading="lazy" decoding="async">
              </button>
            {{ end }}
          </div>
        </div>

        <aside class="pinned-info">
          {{ with $poster }}
            <div class="pinned-poster">
              <img src="{{ . | relURL }}" alt="{{ $project.Title }} poster" loading="lazy" decoding="async">
            </div>
          {{ end }}

          {{ with $summary }}
            <div class="pinned-desc">
              <p>{{ . }}</p>
            </div>
          {{ end }}

          {{ with $release }}
            <div class="pinned-meta">
              <div class="meta-row">
                <div class="meta-k">日期</div>
                <div class="meta-v">{{ . }}</div>
              </div>
            </div>
          {{ end }}

          {{ with $project.Params.tags }}
            <div class="pinned-tags">
              {{ range first 8 . }}<span class="tag">{{ . }}</span>{{ end }}
            </div>
          {{ end }}

          {{ with $project.Params.tech_stack }}
            <div class="pinned-tech">
              <div class="tech-title">技术栈</div>
              <div class="tech-list">
                {{ range . }}<span class="chip">{{ . }}</span>{{ end }}
              </div>
            </div>
          {{ end }}

          <div class="pinned-actions">
            {{ with $project.Params.steam_url }}
              {{ if ne . "" }}<a class="btn primary" href="{{ . }}" target="_blank" rel="noopener noreferrer">Steam 页面</a>{{ end }}
            {{ end }}
            {{ with $project.Params.video_url }}
              {{ if ne . "" }}<button class="btn" data-open-video type="button">观看视频</button>{{ end }}
            {{ end }}
          </div>
        </aside>
      </div>
    </div>
  </section>
{{ end }}
